name: Build
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} 

      - name: Check SonarQube Quality Gate
        run: |
          RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=nithishpk_github-workflow-learning")
          echo "SonarQube API response: $RESPONSE"
          STATUS=$(echo "$RESPONSE" | jq -r .projectStatus.status)
          echo "SonarQube Quality Gate Status: $STATUS"
          if [ "$STATUS" != "OK" ]; then
            echo "Quality gate failed!"
            exit 1
          fi
      - name: discard secrets
        run: |
          echo "printing discard secrets"
          echo "SonarQube scan started for PR #${{ github.event.pull_request.number }}"
             echo "SonarQube scan started for PR #${{ github.event.pull_request.number }}"
          echo "discord secrete: ${{ secrets.DISCORD_WEBHOOK }}"
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      - name: Notify Discord (Failure)
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          content: "Hey ${{ github.actor }}"
          title: "deploy"
          description: "‚ùå SonarQube scan failed for PR #${{ github.event.pull_request.number }}. Please check the merge request for errors: ${{ github.event.pull_request.html_url }}"
          image: ${{ secrets.EMBED_IMAGE }}
          color: 0x0000ff
          url: "https://github.com/sarisia/actions-status-discord"
          username: "Code Monkey Bot üêí"
        #   avatar_url: ${{ secrets.AVATAR_URL }}
       
      - name: Notify Discord (Success)
        if: success()
        uses:  sarisia/actions-status-discord@v1
        with:
            webhook: ${{ secrets.DISCORD_WEBHOOK }}
            status: ${{ job.status }}
            content: "Hey ${{ github.actor }}"
            title: "deploy"
            description: "‚úÖ SonarQube scan passed for PR #${{ github.event.pull_request.number }}. See details: ${{ github.event.pull_request.html_url }}"
            image: ${{ secrets.EMBED_IMAGE }}
            color: 0x0000ff
            url: "https://github.com/sarisia/actions-status-discord"
            username: Code Monkey Bot üêí
