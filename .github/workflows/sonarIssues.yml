name: Build
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      
      - name: SonarQube Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed for PR decoration
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=nithishpk_github-workflow-learning
            -Dsonar.organization=nithishpk

      - name: Check SonarQube Quality Gate
        id: sonar-quality-gate
        run: |
          echo "Waiting for SonarQube analysis to complete..."
          sleep 30  # Wait for analysis to complete
          
          RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=nithishpk_github-workflow-learning")
          
          echo "SonarQube API response: $RESPONSE"
          
          # Check if response is valid JSON
          if ! echo "$RESPONSE" | jq . > /dev/null 2>&1; then
            echo "Invalid JSON response from SonarCloud API"
            echo "quality_gate_status=ERROR" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          STATUS=$(echo "$RESPONSE" | jq -r '.projectStatus.status // "ERROR"')
          echo "SonarQube Quality Gate Status: $STATUS"
          echo "quality_gate_status=$STATUS" >> $GITHUB_OUTPUT
          
          if [ "$STATUS" != "OK" ]; then
            echo "::error::Quality gate failed with status: $STATUS"
            exit 1
          fi
          
          echo "Quality gate passed successfully"
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Notify Discord if SonarQube Quality Gate fails
      - name: Notify Discord (SonarQube Failed)
        if: always() && steps.sonar-quality-gate.outcome == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: "failure"
          content: "Hey ${{ github.actor }} ğŸš¨"
          title: "SonarQube Quality Gate Failed"
          description: |
            âŒ **Code Quality Issues Detected!**
            
            **Project**: `${{ github.repository }}`
            **Branch**: `${{ github.ref_name }}`
            **Commit**: `${{ github.sha }}`
            **Quality Gate Status**: `${{ steps.sonar-quality-gate.outputs.quality_gate_status }}`
            
            ğŸ” **Issues Found**: Code quality standards not met
            ğŸ“Š **View Details**: [SonarCloud Dashboard](https://sonarcloud.io/project/overview?id=nithishpk_github-workflow-learning)
            ğŸ”§ **Action Required**: Fix code quality issues before deployment
            
            ${{ github.event.pull_request.html_url && format('**PR Link**: {0}', github.event.pull_request.html_url) || format('**Workflow**: {0}/{1}/actions/runs/{2}', github.server_url, github.repository, github.run_id) }}
          color: 0xff4444  # Red for SonarQube failure
          url: "https://sonarcloud.io/project/overview?id=nithishpk_github-workflow-learning"
          username: "Code Quality Bot ğŸ”"

      # Only proceed with deployment if SonarQube passes
      - name: Setup SSH Key
        if: steps.sonar-quality-gate.outcome == 'success'
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.THINKIFY_PEM_KEY }}
          known_hosts: 35.154.159.94

      - name: Deploy to Lightsail
        if: steps.sonar-quality-gate.outcome == 'success'
        id: deployment
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@35.154.159.94 << 'EOF'
            cd /home/thinkif-schoolerp/htdocs/schoolerp.thinkif.in/
            sudo bash -c 'echo "Deployment successful at $(date)" > deployment.log'
            echo "Deployment completed successfully"
          EOF

      # Notify Discord if deployment fails (but SonarQube passed)
      - name: Notify Discord (Deployment Failed)
        if: always() && steps.sonar-quality-gate.outcome == 'success' && steps.deployment.outcome == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: "failure"
          content: "Hey ${{ github.actor }} ğŸš¨"
          title: "Deployment Failed"
          description: |
            âŒ **Deployment Error!**
            
            **Project**: `${{ github.repository }}`
            **Branch**: `${{ github.ref_name }}`
            **Status**: SonarQube âœ… | Deployment âŒ
            
            ğŸ”§ **Issue**: Server deployment failed
            ğŸ“‹ **Check**: Server connectivity, permissions, or deployment script
            
            ${{ github.event.pull_request.html_url && format('**PR Link**: {0}', github.event.pull_request.html_url) || format('**Workflow**: {0}/{1}/actions/runs/{2}', github.server_url, github.repository, github.run_id) }}
          color: 0xff8800  # Orange for deployment failure
          url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          username: "Deployment Bot ğŸš€"

      # Notify Discord on successful deployment
      - name: Notify Discord (Success)
        if: steps.sonar-quality-gate.outcome == 'success' && steps.deployment.outcome == 'success'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: "success"
          content: "Hey ${{ github.actor }} ğŸ‰"
          title: "Deployment Successful"
          description: |
            âœ… **All Systems Go!**
            
            **Project**: `${{ github.repository }}`
            **Branch**: `${{ github.ref_name }}`
            **Status**: SonarQube âœ… | Deployment âœ…
            **Quality Gate**: `${{ steps.sonar-quality-gate.outputs.quality_gate_status }}`
            
            ğŸ” **Quality**: Code passed all quality checks
            ğŸš€ **Deployed**: Server updated successfully
            ğŸ“Š **SonarCloud**: [View Report](https://sonarcloud.io/project/overview?id=nithishpk_github-workflow-learning)
            
            ${{ github.event.pull_request.html_url && format('**PR Link**: {0}', github.event.pull_request.html_url) || format('**Workflow**: {0}/{1}/actions/runs/{2}', github.server_url, github.repository, github.run_id) }}
          color: 0x00ff88  # Green for success
          url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          username: "Code Monkey Bot ğŸ’"